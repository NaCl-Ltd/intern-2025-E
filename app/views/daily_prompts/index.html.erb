<% content_for :title, "Daily Prompts" %>

<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div id="daily-prompt-section" class="mb-4 p-4 bg-light rounded">
        <h4 class="mb-3">Daily Prompt / 日替わりお題</h4>
        
        <% if @daily_prompt %>
          <div id="prompt-content" class="mb-3">
            <p id="prompt-text" class="lead"><%= @daily_prompt.text_for_locale(@current_language) %></p>
          </div>
          
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <button id="refresh-prompt" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-sync-alt"></i> New Question
              </button>
            </div>
            
            <div class="language-toggle">
              <button class="btn btn-outline-secondary btn-sm language-btn <%= 'active' if @current_language == 'en' %>" 
                      data-language="en">EN</button>
              <button class="btn btn-outline-secondary btn-sm language-btn <%= 'active' if @current_language == 'ja' %>" 
                      data-language="ja">JP</button>
            </div>
          </div>
          
          <!-- Debug info (remove in production) -->
          <div id="debug-info" class="mt-2 text-muted small">
            <p>Current Language: <span id="current-lang"><%= @current_language %></span></p>
            <p>User seen prompts: <%= current_user.viewed_prompts.count %></p>
            <p>Total prompts: <%= Prompt.count %></p>
          </div>
        <% else %>
          <p class="text-muted">No prompts available. Please add some prompts to the database.</p>
          
          <div class="alert alert-info">
            <h5>Add some prompts to get started:</h5>
            <p>Run this in your Rails console:</p>
            <pre><code>rails console
Prompt.create!(translations: { 'en' => 'What are you grateful for today?', 'ja' => '今日感謝していることは何ですか？' })</code></pre>
          </div>
        <% end %>
      </div>
      
      <!-- Link back to home -->
      <div class="text-center">
        <%= link_to "← Back to Home", root_path, class: "btn btn-secondary" %>
      </div>
    </div>
  </div>
</div>

<script>
$(document).ready(function() {
  console.log('Daily prompt script loaded');
  
  // Get CSRF token for AJAX requests
  const token = $('meta[name="csrf-token"]').attr('content');
  
  $.ajaxSetup({
    beforeSend: function(xhr) {
      xhr.setRequestHeader('X-CSRF-Token', token);
    }
  });
  
  // Refresh prompt
  $('#refresh-prompt').click(function() {
    console.log('Refresh button clicked');
    const button = $(this);
    const originalText = button.html();
    
    button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Loading...');
    
    $.ajax({
      url: '<%= refresh_daily_prompts_path %>',
      method: 'POST',
      headers: {
        'X-CSRF-Token': token
      }
    })
    .done(function(data) {
      console.log('Refresh response received:', data);
      if (data.success) {
        $('#prompt-text').text(data.prompt_text);
        console.log('Updated prompt text to:', data.prompt_text);
        
        // Show success message briefly
        button.html('<i class="fas fa-check"></i> Updated!');
        setTimeout(function() {
          button.html(originalText);
        }, 1000);
      } else {
        console.error('Refresh failed:', data.error);
        alert('Error loading new prompt: ' + data.error);
      }
    })
    .fail(function(xhr, status, error) {
      console.error('Refresh AJAX failed:', error, xhr.responseText);
      alert('Error loading new prompt. Please try again.');
      console.error('Status:', xhr.status);
      console.error('Response:', xhr.responseText);
    })
    .always(function() {
      button.prop('disabled', false);
      if (!button.html().includes('Updated!')) {
        button.html(originalText);
      }
    });
  });
  
  // Language toggle
  $('.language-btn').click(function() {
    const language = $(this).data('language');
    const button = $(this);
    
    console.log('Language button clicked:', language);
    
    // Disable all language buttons during request
    $('.language-btn').prop('disabled', true);
    
    $.ajax({
      url: '<%= update_language_daily_prompts_path %>',
      method: 'PATCH',
      data: { language: language },
      headers: {
        'X-CSRF-Token': token
      }
    })
    .done(function(data) {
      console.log('Language response received:', data);
      if (data.success) {
        // Update active state
        $('.language-btn').removeClass('active');
        button.addClass('active');
        
        // Update debug info
        $('#current-lang').text(data.new_language);
        
        // Reload the page to update the prompt text in the new language
        setTimeout(function() {
          location.reload();
        }, 500);
      } else {
        console.error('Language update failed:', data.error);
        alert('Error changing language: ' + data.error);
      }
    })
    .fail(function(xhr, status, error) {
      console.error('Language AJAX failed:', error, xhr.responseText);
      alert('Error changing language. Please try again.');
      console.error('Status:', xhr.status);
      console.error('Response:', xhr.responseText);
    })
    .always(function() {
      $('.language-btn').prop('disabled', false);
    });
  });
});
</script>

<style>
.language-btn.active {
  background-color: #007bff;
  color: white;
}

.language-btn:disabled {
  opacity: 0.6;
}

#debug-info {
  border-top: 1px solid #ddd;
  padding-top: 10px;
}

.container {
  margin-top: 20px;
}
</style>